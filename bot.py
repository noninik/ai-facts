import random
import os
import sys
from datetime import datetime, timezone, timedelta
import requests

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHANNEL_ID = os.getenv("CHANNEL_ID")
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

GROQ_URL = "https://api.groq.com/openai/v1/chat/completions"
MODEL = "llama-3.3-70b-versatile"

HASHTAGS = "#—Ñ–∞–∫—Ç—ã #–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ #–Ω–∞—É–∫–∞ #—É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–µ"

CATEGORIES = [
    "–∫–æ—Å–º–æ—Å –∏ –≤—Å–µ–ª–µ–Ω–Ω–∞—è",
    "—á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ –∏ –º–æ–∑–≥",
    "–∂–∏–≤–æ—Ç–Ω—ã–µ –∏ –ø—Ä–∏—Ä–æ–¥–∞",
    "–∏—Å—Ç–æ—Ä–∏—è –∏ –¥—Ä–µ–≤–Ω–∏–µ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏",
    "–æ–∫–µ–∞–Ω –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–π –º–∏—Ä",
    "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ª—é–¥–µ–π",
    "–µ–¥–∞ –∏ –∫—É–ª–∏–Ω–∞—Ä–∏—è",
    "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è",
    "—è–∑—ã–∫–∏ –∏ –∫—É–ª—å—Ç—É—Ä—ã –º–∏—Ä–∞",
    "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ —á–∏—Å–ª–∞",
    "–≥–µ–æ–≥—Ä–∞—Ñ–∏—è –∏ —Å—Ç—Ä–∞–Ω—ã",
    "–º—É–∑—ã–∫–∞ –∏ –∑–≤—É–∫–∏",
    "—Å–ø–æ—Ä—Ç –∏ —Ä–µ–∫–æ—Ä–¥—ã",
    "–¥–µ–Ω—å–≥–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∞",
    "—Å–æ–Ω –∏ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏—è",
    "—Ü–≤–µ—Ç–∞ –∏ –∑—Ä–µ–Ω–∏–µ",
    "–≤—Ä–µ–º—è –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏",
    "–ø–æ–≥–æ–¥–∞ –∏ –∫–ª–∏–º–∞—Ç",
    "–º–∏–∫—Ä–æ–±—ã –∏ –±–∞–∫—Ç–µ—Ä–∏–∏",
    "–º–∏—Ñ—ã –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ —Å—á–∏—Ç–∞—é—Ç –ø—Ä–∞–≤–¥–æ–π",
]

FORMATS = [
    {
        "system": "–¢—ã –∞–≤—Ç–æ—Ä –Ω–∞—É—á–Ω–æ-–ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ü–∏—à–µ—à—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
        "prompt": "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å –æ–¥–Ω–∏–º —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–º —Ñ–∞–∫—Ç–æ–º –Ω–∞ —Ç–µ–º—É: {topic}. –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã '–ê –≤—ã –∑–Ω–∞–ª–∏, —á—Ç–æ...'. –ü–æ—Ç–æ–º –æ–±—ä—è—Å–Ω–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö. –í –∫–æ–Ω—Ü–µ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å —á–∏—Ç–∞—Ç–µ–ª—è–º. 80-120 —Å–ª–æ–≤.",
    },
    {
        "system": "–¢—ã –∞–≤—Ç–æ—Ä –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ü–∏—à–µ—à—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
        "prompt": "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç '–¢–û–ü-3 –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–∞' –Ω–∞ —Ç–µ–º—É: {topic}. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ü—Ä–æ–Ω—É–º–µ—Ä—É–π —ç–º–æ–¥–∑–∏ 1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£. –í –∫–æ–Ω—Ü–µ –Ω–∞–ø–∏—à–∏ –∫–∞–∫–æ–π —Ñ–∞–∫—Ç —É–¥–∏–≤–∏–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –∏ –ø–æ–ø—Ä–æ—Å–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö. 80-120 —Å–ª–æ–≤.",
    },
    {
        "system": "–¢—ã —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å –º–∏—Ñ–æ–≤. –ü–∏—à–µ—à—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
        "prompt": "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç-—Ä–∞–∑–æ–±–ª–∞—á–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –º–∏—Ñ–∞ –Ω–∞ —Ç–µ–º—É: {topic}. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ –º–∏—Ñ –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ —Å—á–∏—Ç–∞—é—Ç –ø—Ä–∞–≤–¥–æ–π. –ü–æ—Ç–æ–º –æ–±—ä—è—Å–Ω–∏ –∫–∞–∫ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ. –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã '‚ùå –ú–ò–§:' –ø–æ—Ç–æ–º '‚úÖ –ü–†–ê–í–î–ê:'. 80-120 —Å–ª–æ–≤.",
    },
    {
        "system": "–¢—ã –∞–≤—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è—Ö –∏ –º–∞—Å—à—Ç–∞–±–∞—Ö. –ü–∏—à–µ—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
        "prompt": "–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º –∏–ª–∏ –º–∞—Å—à—Ç–∞–±–æ–º –Ω–∞ —Ç–µ–º—É: {topic}. –ü–æ–∫–∞–∂–∏ —á—Ç–æ-—Ç–æ –ø—Ä–∏–≤—ã—á–Ω–æ–µ –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º –º–∞—Å—à—Ç–∞–±–µ. –ù–∞–ø—Ä–∏–º–µ—Ä '–µ—Å–ª–∏ –±—ã –ó–µ–º–ª—è –±—ã–ª–∞ —Ä–∞–∑–º–µ—Ä–æ–º —Å –∞—Ä–±—É–∑ —Ç–æ –õ—É–Ω–∞ –±—ã–ª–∞ –±—ã –∫–∞–∫ —è–±–ª–æ–∫–æ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 7 –º–µ—Ç—Ä–æ–≤'. –£–¥–∏–≤–∏ —á–∏—Ç–∞—Ç–µ–ª—è. 80-120 —Å–ª–æ–≤.",
    },
    {
        "system": "–¢—ã –∞–≤—Ç–æ—Ä –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏—Å—Ç–æ—Ä–∏–π –æ–± —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö. –ü–∏—à–µ—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
        "prompt": "–†–∞—Å—Å–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫—É—é —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–ª–∏ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏—è –Ω–∞ —Ç–µ–º—É: {topic}. –ö—Ç–æ –æ—Ç–∫—Ä—ã–ª, –∫–∞–∫ —ç—Ç–æ –±—ã–ª–æ, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ. 80-120 —Å–ª–æ–≤.",
    },
]


def generate_post():
    topic = random.choice(CATEGORIES)
    fmt = random.choice(FORMATS)

    headers = {
        "Authorization": "Bearer " + GROQ_API_KEY,
        "Content-Type": "application/json",
    }

    body = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": fmt["system"]},
            {"role": "user", "content": fmt["prompt"].format(topic=topic)},
        ],
        "temperature": 0.9,
        "max_tokens": 400,
    }

    print("Calling Groq API...")
    resp = requests.post(GROQ_URL, headers=headers, json=body, timeout=30)
    print("Status:", resp.status_code)

    if resp.status_code != 200:
        print("Groq error:", resp.text)
        sys.exit(1)

    result = resp.json()
    content = result["choices"][0]["message"]["content"]
    return content, topic


def send_to_telegram(text):
    url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage"
    payload = {"chat_id": CHANNEL_ID, "text": text, "disable_web_page_preview": True}
    return requests.post(url, json=payload, timeout=30).json()


def main():
    print("=== FACTS BOT START ===")

    if not TELEGRAM_BOT_TOKEN or not CHANNEL_ID or not GROQ_API_KEY:
        print("ERROR: env vars not set")
        sys.exit(1)

    content, topic = generate_post()
    print("Topic:", topic)

    msk = timezone(timedelta(hours=3))
    hour = datetime.now(msk).hour
    if 5 <= hour < 12:
        greeting = "üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–π —Ñ–∞–∫—Ç!"
    elif 12 <= hour < 17:
        greeting = "üß† –§–∞–∫—Ç –¥–Ω—è!"
    elif 17 <= hour < 22:
        greeting = "üåÜ –í–µ—á–µ—Ä–Ω–∏–π —Ñ–∞–∫—Ç!"
    else:
        greeting = "üåô –§–∞–∫—Ç –Ω–∞ –Ω–æ—á—å!"

    full_post = greeting + "\n\n" + content + "\n\n" + HASHTAGS

    print("Sending to Telegram...")
    result = send_to_telegram(full_post)

    if result.get("ok"):
        print("SUCCESS!")
    else:
        print("ERROR:", result)
        sys.exit(1)

    print("=== DONE ===")


if __name__ == "__main__":
    main()
